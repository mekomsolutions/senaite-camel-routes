<routes
    xmlns="http://camel.apache.org/schema/spring">
    <!-- No need to add error handling for this route because it is called by the parent inboud-main route which does not need to go through retries given an error occured -->
    <route id="fetch-ServiceRequestTasks">
        <from uri="direct:fetch-ServiceRequestTasks"/>
        
        <log message="Fetching Tasks associated with ServiceRequests " />

        <!-- Fetch requested & accepted Tasks -->
        <to uri="direct:authenticate-toOpenmrs"/>

        <setHeader name="CamelHttpMethod">
            <constant>GET</constant>
        </setHeader>

        <toD cacheSize="-1" uri="{{openmrs.baseUrl}}/ws/fhir2/R4/Task?status=requested,accepted"/>
        <unmarshal>
            <json library="Jackson"/>
        </unmarshal>

        <choice>
            <when>
                <jsonpath>$.[?(@.entry)]</jsonpath>

                <setBody>
                    <jsonpath>$.entry</jsonpath>
                </setBody>

                <setBody>
                    <jsonpath suppressExceptions="true">$.[?(@.resource.basedOn[0].type == 'ServiceRequest')]</jsonpath>
                </setBody>

                <marshal>
                    <json library="Jackson"/>
                </marshal>
            </when>
            <otherwise>
                <setBody>
                    <simple>[]</simple>
                </setBody>
            </otherwise>
        </choice>
    </route>
</routes>
